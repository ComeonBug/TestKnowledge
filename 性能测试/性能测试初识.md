# 声明

1. 性能测试只测不调==不测 ——》对运维没啥价值

对线上的主机有没有明确的规划？

# 什么是性能测试

通过一些工具、通过特定的测试方法，对系统施加压力、得到各项性能指标和结果的过程



# 需要做性能测试的业务场景

1. 业务峰值稳定性测试
2. 新系统上线、交付
3. 技术升级验证
4. 容量规划——》容量测试（也属于性能测试）
5. 性能摸底



# 性能测试的目的和价值

1. 评估系统的能力
2. 识别系统的瓶颈
3. 检查系统的隐藏问题
4. 检查系统稳健性
5. 容量规划





# 行业内流行的测试工具：

Apache AB：轻量级的HTTP测试工具

Apache Jmeter

LoadRunner

Ngrinder（开源、Jython、有界面）

Locust（开源、python、有界面）

阿里PTS



## Apache AB：

轻量级的HTTP测试工具

使用举例：

```swift
ab -n 50 -c 50 http://127.0.0.1:8080/setUrl
```

```swift
-n 表示执行多少个请求
-c 表示同一时间有多少个并发。
```

限制：

1.只支持http

2.参数化麻烦

3.无法支持场景化



## Jmeter：

多协议：数据库、web、FTP、TCP、java

可以二次开发

可以无界面压测

支持分布式集群压测

支持场景化

参数化容易



# 工具选型：

## 发压工具选型：

1. 单接口、一次性：apache ab
2. 复杂事务：jemeter场景构造
3. <1千 QPS 或者 万级以上：jmeter支持分布式
4. 是否是周期性任务：Jmeter生成jmx场景文件多次可重复性使用，数据驱动可使用不同数据多次测试，结果落库，多次结果做对比
5. 二次开发需求：Jmeter开源插件化思想，支持Thrift、Dubbo等多种协议，可以快速平台话
6. 问题支持：Jmeter开发社区



## 监控工具

1.top（实时数据）

2.vmstatus（实时数据）

3.nmon（过程图标，测试用的多）

4.Collectd（守护进程方式，C语言实现，很多插件，运维用的多，常使用Collectd+InfluxDB+Grafana）

5.prometheus（influndb + prometheus + grafana）



## 性能剖析工具

dump



# 性能测试流程

1. 需求分析

2. 制定性能测试计划和方案（看做啥子类型的性能测试，测试场景定下，预期的一个目标是啥）

   - 基准测试：单接口基准测试，是为了在没有压力的情况下做摸底测试，基准测试都不过的话，就没有必要走下面的流程

   - 负载测试：找拐点

   - 压力测试

   - 稳定性测试

   - 极限测试

   - 浪涌测试（打满-释放-打满-释放）

   - 配置测试  

3. 准备
   - 环境设计
   - 硬件环境
   - 软件环境
   - 部署服务
   - 待测接口列表
   - 测试数据准备
     - 旧数据来源是运维、运营、产品
     - 新数据来源是预估
4. 执行
   - 脚本生成，调通
   - 脚本增强：
     - 提取变量
     - token配置
     - 等待时间
     - 提取公共参数
     - 参数化
   - case场景搭建
     - 集合点：Sleeping_Thread_Group
     - 定时器
     - 控制器
       - 事物控制器
       - 仅一次控制器
       - 吞吐量控制器
   - 搭建指标监控
   - 执行case：确认下面点，确保流量真正打到了被压测的服务器上
     - 网络最大带宽
     - 是否有单ip地址限制
     - slb自动伸缩是否生效
     - nginx负载均衡是否生效
     - nginx机器性能是否受限
     - 是否有限流、熔断、降级策略
     - 施压机是否本身有机器性能瓶颈
   - 输出结果
5. 调优
   - 调优
   - 执行case
   - 输出结果
   - 调优
   - ....
6. 报告与总结
   - 概述：目的、背景、需求、名词解释
   - 概要：测试环境、工具及版本、人员情况
   - 测试方案：数据准备、场景设计、脚本准备、环境部署脚本
   - 调优过程：出问题的场景、图、数据、优化方案、优化前后对比
   - 测试结果和分析：压测数据、图表、结论



## Jmeter无界面压测

优点：

1. 节约资源
2. 快捷
3. 可用于集成到CI/CD流程中
4. 可用于分布式压测

命令：

```shell
jmeter -n -t test.jmx -l result.jtl -e -o reports -r
```

```shell
jmeter -n -t test.jmx -l result.jtl -e -o reports -R 192.168.1.101,192.168.1.102
```

参数说明：

-r 启动所有远程压力机进行压测

-R 启动这两台192.168.1.101,192.168.1.102压力机进行压测

可以在控制机执行 htop 在当下查看指标



## Jmeter容器运行

k8s非常适合这种模式：一个主服务接收用户请求，分发到多个从服务，从服务进行压力执行测试，主服务把压力性能相关数据（TPS、相应时间）等存到influxDB 中，再由grafana展示

可以直接clone这个项目：

https://github.com/kubernauts/jmeter-kubernetes

这里有jemter如何通过k8s其主master服务 node、

![image-20240426151803187](%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%88%9D%E8%AF%86.assets/image-20240426151803187.png)



## 监控

使用方案为：prometheus + fluentdb + grafana

注意：在压测过程中所有的中间件都要监控起来，所以中间件的服务上都要部署exporter



## 性能瓶颈举例



### CPU高

top查看cpu高的进程pid

查看是什么应用

如果是java应用，查看这个线程的堆栈，看消耗在哪个环节

```shell
jps -lvm # 查看机器上所有运行中的java进程,找到应用程序的java进行
jstack -l java进程号 # 查看该java的应用的堆栈信息
```

![image-20240426123514535](%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%88%9D%E8%AF%86.assets/image-20240426123514535.png)



### 内存高

top查看cpu高的进程pid

看是进程消耗大 还是swap大？



### 磁盘I/O高

减少日志输出

增加异步处理

换磁盘



### 网络I/O高

确认传输内容的大小

减少传输内容

增加本地缓存

分片传输



### 硬件指标正常性能差

先查看中间件的指标

​	比如：线程池、连接池、JVM数

​	可能是设置的不足、或者是发生阻塞、未释放

中间件没问题就看数据库

​	是不是有慢查询、锁

​	设置参数、设置命中率

如果以上都没有问题

​	优化程序

​	增加缓存、异步机制



## 全链路性能测试

线下测试的”不一致“很难保证：环境配置、不同的机房、网络抖动——》所以有了【全链路性能测试】

证据链

过程 数据

　



