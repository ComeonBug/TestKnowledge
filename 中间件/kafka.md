## 概述

消息订阅的方式

关键概念：消息、生产者、消费者、主题（topic）、分区（Partition）

异步消息通信

## 观察者模式

观察者模式（observer 到货通知），也叫：发布订阅模式（publish subscribe）

观察者模式的要素：

​	1.有个对象

​	2.有个观察者，在观察这个对象

## 传统的模式

传统的模式：生产者消费者模式

​	生产者直接把消息发送给消费者

​	生产者 -> 存储中介（先进先出） —> 消费者

### 传统模式的缺点：

	1. 耦合性太高
 	2. 任意变化都要重写
 	3. 消息阻塞



传统模式为了解决上面的缺点，在存储中介层加入【缓冲区】

这样可以

1. 解耦

2. 支持并发

3. 解决忙闲不均

   

## 名词解释

### 消息

消息就是一条数据

一条消息包含：topic、partition、键、分区器

### 生产者

生产者：发布消息的【人｜程序】



### 消费者

消费者：读取（订阅）消息的【人｜程序】



### topic

topic（主题｜类别）：消息的标识字段（类似于数据库的表名）

​	物理上：不同的topic是分开存储的

​	逻辑上：一个topic的消息虽然保存在一个或者多个broker上，单用户只需指定topic即可，不需要关注存储的细节

一个topic中可能含有多个partition

### partition

分区（partition）：

partition是一个物理上的概念

一个topic中可能含有多个partition，partition可以分布在不同的服务器上，这样topic就相当于分布在不同的服务器上了

但是，消费者之关心订阅了什么topic，而这个topic消息分布在哪个partition上，消费者是不关心的

当生产者产生消息后，根据分配策略，选择分区，然后将消息追加到指定分区的末尾

partition分为：leader partition和follow partition

follow partition是replication，备份

一个partition内，数据是有序的，不同的partition直接数据是无序的



### 键

键：一个标记，每个消息都对应一个标记，一个键

这个键的作用是：消息被发送到broker时，会根据分区规则选择消息存储到哪个分区里，如果分区规则设置合理，这样就可以实现负载均衡和水平扩展



### 分区器

分区器：一个算法，用来处理消息发送到哪里

就是【分区规则】



### offset

偏移量（offset）：第几个消息，每个消息的偏移量是唯一的。消费者根据这个偏移量来读取数据，消费者只能按顺序读取



### kafka broker

kafka服务器broker：包含多个topic，每个topic又含有多个partition，多个broker组成来kafka集群（复制）





# 消息系统

## 消息系统原理

消息系统负责将数据从一个应用传递到另一个应用，应用不需要关注数据的传递，只需要关注数据的使用即可



## 点对点消息传递

是一个消息队列，消费后，这个消息就没有了



## 发布订阅模式

消息持久化到topic 中，可以多次消息

（发布者、订阅者）

kafka采取 **拉取** 模式



## 拉取模式优点

优点：

1. 解耦

2. 冗余（在这里，冗余是优点，可以保障数据的安全）

3. 扩展性

4. 灵活

5. 可恢复性

6. 顺序性

7. 缓冲

8. 异步通信

   

# 问题

## 疑问1:消费者如何拿到自己想要的消息？

答：topic

生产者把消息发给kafka的时候需要标记好消息的topic

消费者只需要获取对应的topic的消息就行

疑问2:生产者怎么知道消息发送到哪个partition呢？

​	1.生产者指定了分区

​	2.生产者没有指定分区，键和分区器起作用，分区器根据键来决定消息的去处



